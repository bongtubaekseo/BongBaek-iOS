//
//  RecommendLottie.swift
//  BongBaek
//
//  Created by hyunwoo on 7/8/25.
//
import SwiftUI

struct RecommendLottie: View {
    @StateObject private var lottieviewModel = RecommendCostViewModel()
    @State private var showRectangle = false
    @State private var progressWidth: CGFloat = 5
    @State private var recommendedAmount: Int = 100000
    @State private var minAmount: Int = 80000
    @State private var maxAmount: Int = 120000

    @EnvironmentObject var router: NavigationRouter
    @EnvironmentObject var eventManager: EventCreationManager

    var body: some View {
        VStack(spacing: 30) {
            Spacer()

            if !showRectangle {
                LottieView(
                    animationFileName: "envelope",
                    loopMode: .playOnce,
                    completion: { finished in
                        if finished {
                            showRectangle = true
                        }
                    }
                )
                .offset(y: -20)

                VStack(spacing: 24) {
                    VStack(spacing: 40) {
                        amountLottieSection
                        categorySection
                    }
                    .padding(.horizontal, 20)
                }
                .padding(.bottom, 40)
            }

            if showRectangle {
                ScrollView {
                    VStack(spacing: 24) {
                        headerSection
                        
                        VStack(spacing: 40) {
                            amountRangeSection
                            categorySection
                        }
                        .padding(.horizontal, 20)
                        
                        noticeSection
                            .padding(.horizontal, 20)
                        
                        participationSection
                            .padding(.horizontal, 20)
                        
                        bottomButtons
                    }
                    .padding(.bottom, 40)
                }
            }

            Spacer()
        }
        .onAppear {
            if let data = eventManager.recommendationResponse?.data {
                print("‚úÖ Ï∂îÏ≤ú Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏:")
                print("  üí∞ Ï∂îÏ≤ú Í∏àÏï°: \(data.cost)Ïõê")
                print("  üìä Î≤îÏúÑ: \(data.range.min)Ïõê ~ \(data.range.max)Ïõê")
                print("  üè∑Ô∏è Ïπ¥ÌÖåÍ≥†Î¶¨: \(data.category)")
                print("  üìç Ïû•ÏÜå: \(data.location)")
                
                recommendedAmount = data.cost
                 minAmount = data.range.min
                 maxAmount = data.range.max
            } else {
                print("‚ùå Ï∂îÏ≤ú Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå")
            }
            print("‚è≥ RecommendLottie ÎÇòÌÉÄÎÇ® - path.count: \(router.path.count)")
        }
        .navigationBarHidden(true)
        .navigationBarBackButtonHidden(true)
        .toolbar(.hidden, for: .navigationBar)
        .frame(maxWidth: .infinity, maxHeight: .infinity)
        .background(.gray900)
    }

    var headerSection: some View {
        VStack {
            VStack(spacing: 20) {

                Text("Í≤∞ÌòºÏãù")
                    .bodyMedium14()
                    .foregroundColor(.white)
                    .padding(.horizontal, 16)
                    .padding(.vertical, 8)
                    .background(
                        RoundedRectangle(cornerRadius: 6)
                            .stroke(.primaryNormal, lineWidth: 1)
                            .background(.gray750)
                    )

                VStack(spacing: 24) {
                    Text("Ï∂îÏ≤ú Í∏àÏï°")
                        .captionRegular12()
                        .foregroundColor(.white)
                        .padding(.horizontal, 8)
                        .padding(.vertical, 2)
                        .background(
                            RoundedRectangle(cornerRadius: 4)
                                .fill(.primaryNormal)
                        )

                    HStack(alignment: .bottom, spacing: 4) {
                        Text("\(recommendedAmount)")
                            .font(.system(size: 46, weight: .bold))
                            .foregroundStyle(
                                LinearGradient(
                                    colors: [
                                        Color(hex: "#4E62FF"),
                                        Color(hex: "#502EFF"),
                                    ],
                                    startPoint: .leading,
                                    endPoint: .trailing
                                )
                            )

                        Text("Ïõê")
                            .titleSemiBold22()
                            .foregroundColor(.gray600)
                            .padding(.bottom, 8)
                    }

                    VStack(spacing: 6) {
                        Text("Ï†ÅÏ†àÌïú Í∏àÏï°Ïù¥ÏóêÏöî!")
                            .bodyMedium16()
                            .foregroundColor(.white)

                        Text("ÏïåÎ†§Ï£ºÏã† Ï†ïÎ≥¥Î•º Í≥†Î†§Ìïú Ï∂îÏ≤úÏûÖÎãàÎã§")
                            .bodyRegular14()
                            .foregroundColor(.gray200)
                    }
                    .padding(.horizontal, 24)
                    .padding(.vertical, 10)
                    .background(
                        RoundedRectangle(cornerRadius: 10)
                            .fill(.gray750.opacity(0.6))
                    )
                }
                .padding(.horizontal, 30)
                .padding(.vertical, 30)
                .background(
                    RoundedRectangle(cornerRadius: 12)
                        .fill(
                            LinearGradient(
                                colors: [
                                    Color(hex: "#A6BEF3"),
                                    Color(hex: "#D3D9FF"),
                                ],
                                startPoint: .topLeading,
                                endPoint: .bottomTrailing
                            )
                        )
                )
            }
            .transition(.opacity.combined(with: .scale))
        }
    }
    
    var amountLottieSection: some View {
            VStack(alignment: .leading, spacing: 16) {
                Text("Ï†ÅÏ†ï Î≤îÏúÑ")
                    .titleSemiBold18()
                    .foregroundColor(.white)

                VStack(spacing: 8) {
                    ZStack(alignment: .leading) {
                        RoundedRectangle(cornerRadius: 4)
                            .fill(Color(hex: "#292929"))
                            .frame(width: 300, height: 12)

                        RoundedRectangle(cornerRadius: 4)
                            .fill(
                                LinearGradient(
                                    colors: [
                                        Color(hex: "#502EFF"),
                                        Color(hex: "#807FFF"),
                                    ],
                                    startPoint: .leading,
                                    endPoint: .trailing
                                )
                            )
                            .frame(width: 5, height: 12)
                    }
                    .frame(maxWidth: .infinity, alignment: .leading)

                    HStack {
                        Text("\(lottieviewModel.formattedMinAmount)Ïõê")
                            .captionRegular12()
                            .foregroundColor(.gray400)

                        Spacer()

                        Text("\(lottieviewModel.formattedMaxAmount)Ïõê")
                            .captionRegular12()
                            .foregroundColor(.gray400)
                    }
                }
            }
            .padding(16)
            .background(
                RoundedRectangle(cornerRadius: 10)
                    .fill(Color.black)
            )
        }

    var amountRangeSection: some View {
        VStack(alignment: .leading, spacing: 16) {
            Text("Ï†ÅÏ†ï Î≤îÏúÑ")
                .titleSemiBold18()
                .foregroundColor(.white)

            VStack(spacing: 8) {
                ZStack(alignment: .leading) {
                    RoundedRectangle(cornerRadius: 4)
                        .fill(Color(hex: "#292929"))
                        .frame(width: 300, height: 12)

                    RoundedRectangle(cornerRadius: 4)
                        .fill(
                            LinearGradient(
                                colors: [
                                    Color(hex: "#502EFF"),
                                    Color(hex: "#807FFF"),
                                ],
                                startPoint: .leading,
                                endPoint: .trailing
                            )
                        )
                        .frame(width: progressWidth, height: 12)
                        .animation(.easeInOut(duration: 1.5), value: progressWidth)
                }
                .frame(maxWidth: .infinity, alignment: .leading)

                HStack {
                    Text("\(minAmount)Ïõê")
                        .captionRegular12()
                        .foregroundColor(.gray400)

                    Spacer()

                    Text("\(maxAmount)Ïõê")
                        .captionRegular12()
                        .foregroundColor(.gray400)
                }
            }
        }
        .padding(16)
        .background(
            RoundedRectangle(cornerRadius: 10)
                .fill(Color.black)
        )
        .onAppear {
            DispatchQueue.main.asyncAfter(deadline: .now()) {
                progressWidth = 150 //Ï∂îÏ≤úÎ∞õÏùÄ Í∏àÏï°ÏùÑ ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏïÑÏò¨ Í∞í
            }
        }
    }

    var noticeSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            HStack {
                Image("icon_info")
                Text("Ïù¥Î†áÍ≤å Í≥ÑÏÇ∞ÌñàÏñ¥Ïöî")
                    .titleSemiBold18()
                    .foregroundColor(.white)
                Spacer()
            }

            VStack(alignment: .leading, spacing: 4) {
                Text("‚Ä¢ Ïõî ÏàòÏûÖ Í≥†Î†§")
                    .bodyRegular16()
                    .foregroundColor(.gray400)
                Text("‚Ä¢ ÏπúÍµ¨ Í¥ÄÍ≥Ñ (ÏπúÎ∞ÄÎèÑ Î≥¥ÌÜµ)")
                    .bodyRegular16()
                    .foregroundColor(.gray400)
                Text("‚Ä¢ ÏãùÏÇ¨ Ï∞∏ÏÑù Ïó¨Î∂Ä")
                    .bodyRegular16()
                    .foregroundColor(.gray400)
            }
        }
        .padding(16)
        .background(
            RoundedRectangle(cornerRadius: 10)
                .fill(Color("gray750"))
        )
    }

    var participationSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            HStack {
                Image("icon_colorcheck")
                Text("Ï∞∏Í≥†Ìï¥Ï£ºÏÑ∏Ïöî!")
                    .bodyRegular16()
                    .foregroundColor(.white)
                Spacer()
            }

            VStack(alignment: .leading, spacing: 4) {
                Text("‚Ä¢ ÌôÄÏàò Í∏àÏï°ÏúºÎ°ú Ï§ÄÎπÑÌï¥Ï£ºÏÑ∏Ïöî")
                    .bodyRegular16()
                    .foregroundColor(.gray400)
                Text("‚Ä¢ ÏÉà ÏßÄÌèêÎ°ú Ï§ÄÎπÑÌïòÎäîÍ≤å Ï¢ãÏïÑÏöî")
                    .bodyRegular16()
                    .foregroundColor(.gray400)
                Text("‚Ä¢ Î¥âÌà¨Ïóê Ï†ïÏÑ±Ïä§ÎüΩÍ≤å ÎßàÏùåÏùÑ ÌëúÌòÑÌï¥Î≥¥ÏÑ∏Ïöî")
                    .bodyRegular16()
                    .foregroundColor(.gray400)
            }
        }
        .padding(16)
        .background(
            RoundedRectangle(cornerRadius: 12)
                .fill(Color("gray750"))
        )
    }

    var bottomButtons: some View {
        VStack(spacing: 12) {
            Button("Ïù¥ Í∏àÏï°ÏúºÎ°ú Í≤∞Ï†ïÌïòÍ∏∞") {
                Task {
                    // Ï∂îÏ≤úÎ∞õÏùÄ Í∏àÏï°ÏúºÎ°ú Ïù¥Î≤§Ìä∏ ÏÉùÏÑ±
                    let success = await eventManager.submitEventWithRecommendedAmount()
                    
                    if success {
                        // ÏÑ±Í≥µÌïòÎ©¥ ÏÑ±Í≥µ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
                        await MainActor.run {
                            router.push(to: .recommendSuccessView)
                        }
                    } else {
                        // Ïã§Ìå® Ïãú ÏóêÎü¨ Ï≤òÎ¶¨ (Ïòà: ÏïåÎüø ÌëúÏãú)
                        print("Ïù¥Î≤§Ìä∏ ÏÉùÏÑ± Ïã§Ìå®: \(eventManager.submitError ?? "Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò")")
                        // TODO: ÏóêÎü¨ ÏïåÎüø ÌëúÏãú Î°úÏßÅ Ï∂îÍ∞Ä
                    }
                }
            }
            .frame(maxWidth: .infinity)
            .padding(.vertical, 14)
            .background(Color("primary_normal"))
            .foregroundColor(.white)
            .font(.title_semibold_18)
            .cornerRadius(10)

            Button("Ï∂îÏ≤úÎ∞õÏùÄ Í∏àÏï° ÏàòÏ†ïÌïòÍ∏∞") {
                // EventCreationManagerÏóêÏÑú Ï∂îÏ≤ú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏ÏôÄÏÑú Ï†ÑÎã¨
                router.push(to: .modifyEventView(
                    mode: .edit, eventDetailData: nil
                ))
            }
            .frame(maxWidth: .infinity)
            .padding(.vertical, 14)
            .background(Color("gray700"))
            .foregroundColor(.gray200)
            .font(.title_semibold_18)
            .cornerRadius(10)
        }
    }

    var categorySection: some View {
        HStack(spacing: 12) {
            HStack(spacing: 12) {
                ZStack {
                    Circle()
                        .fill(.gray900)
                        .frame(width: 40, height: 40)

                    Image("icon_star")
                }
                VStack(alignment: .leading, spacing: 2) {
                    Text("Í≤ΩÏ°∞ÏÇ¨ Ï¢ÖÎ•ò")
                        .captionRegular12()
                        .foregroundColor(.gray400)
                    Text("Í≤∞ÌòºÏãù")
                        .bodyMedium16()
                        .foregroundColor(.white)
                }

                Spacer()
            }
            .padding(.horizontal, 14)
            .padding(.vertical, 14)
            .frame(width: 163, height: 70)
            .background(
                RoundedRectangle(cornerRadius: 12)
                    .fill(Color("gray750"))
            )

            HStack(spacing: 12) {
                ZStack {
                    Circle()
                        .fill(.gray900)
                        .frame(width: 40, height: 40)
                    Image("icon_location 2")
                }
                VStack(alignment: .leading, spacing: 2) {
                    Text("Ïû•ÏÜå")
                        .captionRegular12()
                        .foregroundColor(.gray400)
                    Text("ÎçîÎßÅÌÅ¨Ìò∏ÌÖî Ïõ®Îî©")
                        .bodyMedium16()
                        .foregroundColor(.white)
                }
                Spacer()
            }
            .padding(.horizontal, 14)
            .padding(.vertical, 14)
            .frame(width: 164, height: 70)
            .background(
                RoundedRectangle(cornerRadius: 12)
                    .fill(Color("gray750"))
            )
        }
    }
}
