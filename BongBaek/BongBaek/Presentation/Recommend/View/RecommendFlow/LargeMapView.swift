//
//  LargeMapView.swift
//  BongBaek
//
//  Created by ÏûÑÏû¨ÌòÑ on 7/18/25.
//

import SwiftUI

struct LargeMapView: View {
    @State private var searchText = ""
    @FocusState private var isSearchFieldFocused: Bool
    @StateObject private var keywordSearch = KeyWordSearch()
    @State private var mapView: KakaoMapView?
    @State private var showRecommendLoading = false
    
    @EnvironmentObject var router: NavigationRouter
    @EnvironmentObject var eventManager: EventCreationManager
    @Environment(\.dismiss) private var dismiss
    @State private var selectedLocation: KLDocument?
    
    // Î≤ÑÌäº ÌôúÏÑ±Ìôî Ï°∞Í±¥
    private var isNextButtonEnabled: Bool {
        return selectedLocation?.placeName.isEmpty == false
    }
    
    var body: some View {
        ScrollView {
            VStack {
                CustomNavigationBar(title: "ÌñâÏÇ¨Ïû• ÏúÑÏπò") {
                    dismiss()
                }
                
                VStack(alignment: .leading) {
                    // Í≤ÄÏÉâ ÏÑπÏÖòÏùÑ ZStackÏúºÎ°ú Í∞êÏã∏ÏÑú ÎìúÎ°≠Îã§Ïö¥Ïù¥ Î∞îÎ°ú ÏïÑÎûòÏóê ÏúÑÏπòÌïòÎèÑÎ°ù
                    ZStack(alignment: .topLeading) {
                        VStack(alignment: .leading, spacing: 0) {
                            searchSection
                            
                            // ÎìúÎ°≠Îã§Ïö¥Ïù¥ ÌëúÏãúÎê† Í≥µÍ∞Ñ ÌôïÎ≥¥
                            if !searchText.isEmpty &&
                               !keywordSearch.searchResults.isEmpty &&
                               isSearchFieldFocused {
                                Color.clear
                                    .frame(height: CGFloat(keywordSearch.searchResults.count) * 60) // ÎåÄÎûµÏ†ÅÏù∏ ÎÜíÏù¥
                            }
                        }
                        
                        // ÎìúÎ°≠Îã§Ïö¥ Ïò§Î≤ÑÎ†àÏù¥ - searchSection Î∞îÎ°ú ÏïÑÎûòÏóê ÏúÑÏπò
                        VStack(alignment: .leading, spacing: 0) {
                            // TextField ÎÜíÏù¥ÎßåÌÅº Í≥µÍ∞Ñ ÌôïÎ≥¥ (ÏïΩ 48px)
                            Color.clear
                                .frame(height: 48)
                            
                            if !searchText.isEmpty &&
                               !keywordSearch.searchResults.isEmpty &&
                               isSearchFieldFocused {
                                searchResultsOverlay
                            }
                        }
                    }
                    
                    // ÏßÄÎèÑ ÏÑπÏÖò
                    ZStack(alignment: .bottom) {
                        mapSection
                            .padding(.top, 16)
                        
                        // ÏÑ†ÌÉùÎêú ÏúÑÏπò Ï†ïÎ≥¥Î•º ÏßÄÎèÑ ÌïòÎã®Ïóê ÌëúÏãú
                        if let selectedLocation = selectedLocation {
                            selectedLocationOverlay(selectedLocation)
                        }
                    }
                    
                    submitButton
                }
                .padding(.top, 20)
            }
            .onAppear {
                print("üìç EventLocationView ÎÇòÌÉÄÎÇ® - step: 4/4")
                print("‚è≥ path.count: \(router.path.count)")
            }
        }
        .onTapGesture {
            hideKeyboard()
        }
        .navigationBarHidden(true)
        .navigationBarBackButtonHidden(true)
        .toolbar(.hidden, for: .navigationBar)
        .background(Color.background)
        .animation(.easeInOut(duration: 0.3), value: isSearchFieldFocused)
        .onTapGesture {
            isSearchFieldFocused = false
        }
    }
    
    // ÏÑ†ÌÉùÎêú ÏúÑÏπò Ï†ïÎ≥¥Î•º ÏßÄÎèÑ ÌïòÎã®Ïóê ÌëúÏãúÌïòÎäî Ïò§Î≤ÑÎ†àÏù¥
    private func selectedLocationOverlay(_ location: KLDocument) -> some View {
       VStack(alignment: .leading, spacing: 8) {
           Text(location.placeName)
               .font(.system(size: 18, weight: .semibold))
               .foregroundColor(.white)
           
           Text(location.addressName)
               .font(.system(size: 14))
               .foregroundColor(.gray300)
           
       }
       .frame(maxWidth: .infinity, alignment: .leading)
       .padding(.horizontal, 16)
       .padding(.vertical, 12)
       .background(Color.black.opacity(0.8))
       .overlay(
           RoundedRectangle(cornerRadius: 12)
            .stroke(.gray750, lineWidth: 1)
       )
       .cornerRadius(12)
       .padding(.horizontal, 40)
       .padding(.bottom, 20)
       .zIndex(50)
       .transition(.asymmetric(
           insertion: .move(edge: .bottom).combined(with: .opacity),
           removal: .move(edge: .bottom).combined(with: .opacity)
       ))
    }
    
    // MARK: - View Components
    
    private var searchSection: some View {
        HStack(spacing: 12) {
            Image(systemName: "magnifyingglass")
                .foregroundColor(.gray)
                .font(.system(size: 20))
            
            TextField("Ïû•ÏÜåÎ•º Í≤ÄÏÉâÌïòÏÑ∏Ïöî", text: $searchText)
                .font(.system(size: 16))
                .foregroundColor(.white)
                .focused($isSearchFieldFocused)
                .onChange(of: searchText) { _, newValue in
                    keywordSearch.query = newValue
                    keywordSearch.searchResults.removeAll()
                }
            
            // Clear Î≤ÑÌäº Ï∂îÍ∞Ä
            if !searchText.isEmpty {
                Button(action: {
                    searchText = ""
                    keywordSearch.searchResults.removeAll()
                    isSearchFieldFocused = false
                }) {
                    Image(systemName: "xmark.circle.fill")
                        .foregroundColor(.gray)
                        .font(.system(size: 16))
                }
                .transition(.scale.combined(with: .opacity))
            }
        }
        .padding(.horizontal, 16)
        .padding(.vertical, 14)
        .background(Color.gray.opacity(0.2))
        .overlay(
            RoundedRectangle(cornerRadius: 8)
                .stroke(Color.gray.opacity(0.5), lineWidth: 1)
        )
        .cornerRadius(8)
        .padding(.horizontal, 20)
    }
    
    private var mapSection: some View {
        Group {
            if let mapView = mapView {
                mapView
                    .frame(height: 492)
                    .cornerRadius(12)
                    .padding(.horizontal, 20)
            } else {
                Rectangle()
                    .foregroundStyle(.red)
                    .frame(maxWidth: .infinity)
                    .frame(height: 492)
                    .cornerRadius(12)
                    .padding(.horizontal, 20)
                    .onAppear {
                        mapView = KakaoMapView(draw: .constant(true))
                    }
            }
        }
    }
    
    private var searchResultsOverlay: some View {
        VStack(alignment: .leading, spacing: 0) {
            ForEach(keywordSearch.searchResults, id: \.id) { document in
                Button(action: {
                    handleLocationSelection(document)
                }) {
                    HStack {
                        VStack(alignment: .leading, spacing: 2) {
                            Text(document.placeName)
                                .font(.system(size: 16, weight: .medium))
                                .foregroundColor(.white)
                                .frame(maxWidth: .infinity, alignment: .leading)
                            
                            Text(document.addressName)
                                .font(.system(size: 14))
                                .foregroundColor(.gray)
                                .frame(maxWidth: .infinity, alignment: .leading)
                            
                            if !document.roadAddressName.isEmpty {
                                Text(document.roadAddressName)
                                    .font(.system(size: 12))
                                    .foregroundColor(.blue)
                                    .frame(maxWidth: .infinity, alignment: .leading)
                            }
                        }
                        
                        Spacer()
                        
                        Image(systemName: "arrow.up.right")
                            .font(.system(size: 12))
                            .foregroundColor(.gray)
                    }
                    .frame(maxWidth: .infinity)
                    .padding(.horizontal, 16)
                    .padding(.vertical, 12)
                    .contentShape(Rectangle())
                }
                .buttonStyle(PlainButtonStyle())
                
                if document.id != keywordSearch.searchResults.last?.id {
                    Divider()
                        .background(Color.gray.opacity(0.3))
                        .padding(.horizontal, 16)
                }
            }
        }
        .background(Color.gray750)
        .overlay(
            RoundedRectangle(cornerRadius: 8)
                .stroke(Color.gray.opacity(0.5), lineWidth: 1)
        )
        .cornerRadius(12)
        .padding(.horizontal, 20)
        .padding(.top, 8)
        .shadow(color: .black.opacity(0.1), radius: 8, x: 0, y: 4)
        .zIndex(100) // ÎÜíÏùÄ zIndexÎ°ú ÏÑ§Ï†ï
        .transition(.asymmetric(
            insertion: .scale(scale: 0.95, anchor: .top).combined(with: .opacity),
            removal: .scale(scale: 0.95, anchor: .top).combined(with: .opacity)
        ))
    }
    
    private var submitButton: some View {
        Button {
            handleFormSubmission()
        } label: {
            Text("ÏúÑÏπò Ï†ÄÏû•")
                .titleSemiBold18()
                .foregroundColor(isNextButtonEnabled ? .white : .gray400)
        }
        .disabled(!isNextButtonEnabled)
        .frame(maxWidth: .infinity)
        .frame(height: 55)
        .background(isNextButtonEnabled ? .primaryNormal : .gray600)
        .cornerRadius(12)
        .padding(.horizontal, 20)
        .padding(.top, 8)
        .animation(.easeInOut(duration: 0.2), value: isNextButtonEnabled)
    }
    
    // MARK: - Methods
    
    private func handleLocationSelection(_ document: KLDocument) {
        // EventCreationManagerÏóê ÏúÑÏπò Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        selectedLocation = document
        
        // UI ÏóÖÎç∞Ïù¥Ìä∏
        searchText = document.placeName
        isSearchFieldFocused = false
        keywordSearch.searchResults = []
        
        // ÏßÄÎèÑ ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
        if let longitude = Double(document.x),
           let latitude = Double(document.y) {
            mapView?.updateLocation(longitude: longitude, latitude: latitude)
            print("ÏßÄÎèÑ ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏: \(document.placeName)")
            print("Ï¢åÌëú: \(longitude), \(latitude)")
        }
        
        // ÏÑ†ÌÉùÎêú ÏúÑÏπò Ï†ïÎ≥¥ Ï∂úÎ†•
        printLocationSelection(document)
    }
    
    private func handleFormSubmission() {
        guard isNextButtonEnabled else {
            print("‚ö†Ô∏è EventLocationView: UI Í≤ÄÏ¶ù Ïã§Ìå®")
            return
        }
        
        // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï∂úÎ†•
        printCurrentSelections()
        dismiss()
        // Îã§Ïùå ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
//        if eventManager.canCompleteLocationStep {
//            print("‚úÖ EventLocationView: Ìèº Ï†úÏ∂ú ÏÑ±Í≥µ, Ï∂îÏ≤ú Î°úÎî©ÏúºÎ°ú Ïù¥Îèô")
//            router.push(to: .recommendLoadingView)
//        } else {
//            print("‚ùå EventLocationView: EventCreationManager Ïù¥Ï§ë Í≤ÄÏ¶ù Ïã§Ìå®")
//        }
    }
    
    private func handleSkipLocation() {
        print("üîÑ ÏúÑÏπò ÏûÖÎ†• Í±¥ÎÑàÎõ∞Í∏∞")
        
        // ÏúÑÏπò Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî (ÏÑ†ÌÉùÏÇ¨Ìï≠)
//        eventManager.clearLocationData()
        
        // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï∂úÎ†•
        printCurrentSelections()
        
        // Í≤ÄÏ¶ù ÏóÜÏù¥ Î∞îÎ°ú Îã§Ïùå ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
        print("‚úÖ EventLocationView: Í±¥ÎÑàÎõ∞Í∏∞Î°ú Ï∂îÏ≤ú Î°úÎî©ÏúºÎ°ú Ïù¥Îèô")
//        router.push(to: .recommendLoadingView)
    }
    
    private func printLocationSelection(_ document: KLDocument) {
        print("üìç EventLocationView ÏúÑÏπò ÏÑ†ÌÉù:")
        print("  üè¢ Ïû•ÏÜåÎ™Ö: \(document.placeName)")
        print("  üìç Ï£ºÏÜå: \(document.addressName)")
        print("  üõ£Ô∏èÎèÑÎ°úÎ™Ö: \(document.roadAddressName)")
        print("  üåç Ï¢åÌëú: \(document.x), \(document.y)")
        print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
    }
    
    private func printCurrentSelections() {
        print("üìç EventLocationView ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Í∞íÎì§:")
//        print("  üè¢ Ïû•ÏÜåÎ™Ö: '\(eventManager.locationName)'")
//        print("  üìç Ï£ºÏÜå: '\(eventManager.locationAddress)'")
//        print("  üõ£Ô∏è ÎèÑÎ°úÎ™Ö Ï£ºÏÜå: '\(eventManager.locationRoadAddress)'")
//        print("  üåç Ï¢åÌëú: (\(eventManager.longitude), \(eventManager.latitude))")
//        print("  üìç ÏúÑÏπò Îç∞Ïù¥ÌÑ∞ Ï°¥Ïû¨: \(eventManager.hasLocationData)")
//        print("  ‚úÖ Îã§Ïùå Îã®Í≥Ñ ÏßÑÌñâ Í∞ÄÎä•: \(eventManager.canCompleteLocationStep)")
        print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
    }
    
    private func hideKeyboard() {
        UIApplication.shared.sendAction(#selector(UIResponder.resignFirstResponder), to: nil, from: nil, for: nil)
    }
}
