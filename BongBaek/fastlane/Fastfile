# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)
platform :ios do
  desc "Push a new beta build to TestFlight"
  lane :beta do
    begin
      get_certificates
      get_provisioning_profile
      increment_build_number(
          build_number: latest_testflight_build_number + 1
      )
      unlock_keychain(
        path: '/Users/limjaehyeon/Library/Keychains/login.keychain-db',
        password: '0000'
      )
      build_app(
        scheme: "BongBaek",
        export_method: "app-store",
        export_options: {
          provisioningProfiles: {
            "JaeHyeonLim9298.bongbaek" => "JaeHyeonLim9298_BongBaek_AppStore.mobileprovision"
          }
        }
      )
      upload_to_testflight(
         api_key_path: "fastlane/83D8966TA2.json"
      )
      send_discord(message: "ðŸš€ ë² íƒ€ ë°°í¬ ì„±ê³µ! TestFlight ì—…ë¡œë“œ ì™„ë£Œ")
    rescue => error
      send_discord(message: "âŒ ë² íƒ€ ë°°í¬ ì‹¤íŒ¨: #{error.message}")
      raise error
    end
  end

  # ===============================
  # Discord Webhook ì•Œë¦¼
  # ===============================
  private_lane :send_discord do |options|
    require 'date'
    message      = options[:message]
    webhook_url  = ENV["DISCORD_WEBHOOK_URL"]
    
    # webhook_urlì´ ì—†ìœ¼ë©´ Discord ì•Œë¦¼ ê±´ë„ˆë›°ê¸°
    if webhook_url.nil? || webhook_url.empty?
      UI.message("Discord webhook URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤.")
      return
    end
    
    begin
      # ë¹Œë“œ ì •ë³´ ìˆ˜ì§‘ (ê°„ì†Œí™”)
      version      = get_version_number(xcodeproj:"BongBaek.xcodeproj")
      build_number = get_build_number(xcodeproj:"BongBaek.xcodeproj")
      scheme       = "BongBaek"
      target       = "JaeHyeonLim9298.BongBaek"
      git_hash     = sh("git rev-parse --short HEAD").strip rescue "N/A"
      branch       = sh("git rev-parse --abbrev-ref HEAD").strip rescue "N/A"
      timestamp    = DateTime.now.strftime("%Y-%m-%d %H:%M:%S")
    rescue => e

      # ë¹Œë“œ ì •ë³´ ìˆ˜ì§‘ ì‹¤íŒ¨ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
      UI.message("ë¹Œë“œ ì •ë³´ ìˆ˜ì§‘ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©: #{e.message}")
      version = "1.0"
      build_number = "1"
      scheme = "BongBaek"
      target = "JaeHyeonLim9298.BongBaek"
      git_hash = "N/A"
      branch = "N/A"
      timestamp = DateTime.now.strftime("%Y-%m-%d %H:%M:%S")
    end
    
    begin
      # ë””ìŠ¤ì½”ë“œ ë©”ì‹œì§€ í¬ë§·
      payload = {
        content: message,
        embeds: [
          {
            title: "ðŸ“¦ ë°°í¬ ì •ë³´",
            fields: [
              { name: "Version", value: "#{version} (#{build_number})", inline: true },
              { name: "Target", value: target, inline: true },
              { name: "Scheme", value: scheme, inline: true },
              { name: "Branch", value: branch, inline: true },
              { name: "Git Commit", value: git_hash, inline: true },
              { name: "Time", value: timestamp, inline: false }
            ]
          }
        ]
      }
      
      # JSON ë¬¸ìžì—´ë¡œ ë³€í™˜
      require 'json'
      json_payload = payload.to_json
      escaped_payload = Shellwords.escape(json_payload)
      escaped_hook    = Shellwords.escape(webhook_url)
      sh "curl -H \"Content-Type: application/json\" -X POST -d #{escaped_payload} #{escaped_hook}"
      UI.success("Discord ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ!")
    rescue => e
      UI.error("Discord ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: #{e.message}")
    end
  end
end